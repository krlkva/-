<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRLKVA 2048</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            min-height: 100vh;
            background: #faf8ef;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            max-width: 500px;
            width: 100%;
            background: #faf8ef;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .title-section h1 {
            font-size: 48px;
            font-weight: 700;
            color: #776e65;
            line-height: 1;
        }

        .title-section p {
            font-size: 14px;
            color: #776e65;
            margin-top: 4px;
        }

        .scores {
            display: flex;
            gap: 10px;
        }

        .score-card {
            background: #bbada0;
            padding: 10px 20px;
            border-radius: 6px;
            text-align: center;
            min-width: 90px;
        }

        .score-label {
            font-size: 14px;
            color: #eee4da;
            text-transform: uppercase;
            font-weight: 400;
        }

        .score-value {
            font-size: 28px;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }

        .controls-panel {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            align-items: center;
        }

        .btn {
            background: #8f7a66;
            border: none;
            color: #f9f6f2;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            flex: 1;
            text-align: center;
        }

        .btn:hover {
            background: #9f8a76;
        }

        .btn.primary {
            background: #8f7a66;
        }

        .multiplier {
            background: #8f7a66;
            color: #f9f6f2;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 16px;
            min-width: 70px;
            text-align: center;
        }

        .board-container {
            position: relative;
            margin-bottom: 20px;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: #bbada0;
            padding: 15px;
            border-radius: 6px;
            aspect-ratio: 1 / 1;
        }

        .cell {
            background: #cdc1b4;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            font-weight: 700;
            aspect-ratio: 1 / 1;
            color: #776e65;
            transition: all 0.15s ease;
        }

        /* Цвета для плиток */
        .tile-2 { background: #eee4da; color: #776e65; }
        .tile-4 { background: #ede0c8; color: #776e65; }
        .tile-8 { background: #f2b179; color: #f9f6f2; }
        .tile-16 { background: #f59563; color: #f9f6f2; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; }
        .tile-128 { background: #edcf72; color: #f9f6f2; font-size: 36px; }
        .tile-256 { background: #edcc61; color: #f9f6f2; font-size: 36px; }
        .tile-512 { background: #edc850; color: #f9f6f2; font-size: 36px; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 30px; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 30px; }

        .mobile-controls {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .mobile-btn {
            background: #8f7a66;
            border: none;
            color: #f9f6f2;
            font-size: 32px;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .mobile-btn:active {
            background: #9f8a76;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: #faf8ef;
            border-radius: 6px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .modal-content h2 {
            font-size: 36px;
            color: #776e65;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .game-over-message {
            font-size: 18px;
            color: #776e65;
            margin-bottom: 20px;
        }

        .name-input {
            width: 100%;
            padding: 15px;
            background: white;
            border: 2px solid #bbada0;
            border-radius: 6px;
            font-size: 16px;
            color: #776e65;
            margin-bottom: 20px;
        }

        .name-input:focus {
            outline: none;
            border-color: #8f7a66;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
        }

        .saved-message {
            font-size: 18px;
            color: #776e65;
            margin: 20px 0;
            font-weight: 600;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            text-align: left;
        }

        .leaderboard-table th {
            padding: 12px 8px;
            color: #776e65;
            font-weight: 600;
            border-bottom: 2px solid #bbada0;
        }

        .leaderboard-table td {
            padding: 12px 8px;
            color: #776e65;
            border-bottom: 1px solid #d8d0c0;
        }

        .close-btn {
            width: 100%;
            padding: 15px !important;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            color: #776e65;
            font-size: 14px;
        }

        @media (max-width: 520px) {
            .title-section h1 {
                font-size: 36px;
            }
            
            .score-card {
                padding: 8px 12px;
                min-width: 70px;
            }
            
            .score-value {
                font-size: 22px;
            }
            
            .cell {
                font-size: 28px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .mobile-controls {
                display: grid;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .modal-content h2 {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="title-section">
                <h1>KRLKVA 2048</h1>
                <p>Web programming Lab 3</p>
            </div>
            <div class="scores">
                <div class="score-card">
                    <div class="score-label">SCORE</div>
                    <div class="score-value" id="score">0</div>
                </div>
                <div class="score-card">
                    <div class="score-label">BEST</div>
                    <div class="score-value" id="best">0</div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <button class="btn" id="newGameBtn">Начать заново</button>
            <button class="btn" id="undoBtn">Отмена хода</button>
            <button class="btn" id="leaderboardBtn">Лидеры</button>
            <span class="multiplier" id="multiplier">x1</span>
        </div>

        <div class="board-container">
            <div class="board" id="board"></div>
        </div>

        <div class="mobile-controls" id="mobileControls">
            <button class="mobile-btn" data-direction="up">↑</button>
            <button class="mobile-btn" data-direction="left">←</button>
            <button class="mobile-btn" data-direction="down">↓</button>
            <button class="mobile-btn" data-direction="right">→</button>
        </div>

        <div class="footer">
            Королькова Елизавета | Web Programming Lab 3
        </div>
    </div>

    <!-- Модальное окно окончания игры -->
    <div class="modal-overlay hidden" id="gameOverModal">
        <div class="modal-content">
            <h2>Игра завершена!</h2>
            <div class="game-over-message">Введите имя для сохранения рекорда</div>
            <input type="text" class="name-input" id="playerName" placeholder="Ваше имя" maxlength="20">
            <div class="modal-buttons">
                <button class="btn" id="saveScoreBtn">Сохранить результат</button>
                <button class="btn" id="restartFromModalBtn">Начать заново</button>
            </div>
            <div class="saved-message hidden" id="savedMessage">Ваш рекорд сохранен!</div>
        </div>
    </div>

    <!-- Модальное окно лидеров -->
    <div class="modal-overlay hidden" id="leaderboardModal">
        <div class="modal-content">
            <h2>Таблица лидеров</h2>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Игрок</th>
                        <th>Очки</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
            </table>
            <button class="btn close-btn" id="closeLeaderboardBtn">Закрыть</button>
        </div>
    </div>

    <script>
        (function() {
            // Константы
            const SIZE = 4;
            const STORAGE_KEY = 'krlkva2048_state';
            const LEADERBOARD_KEY = 'krlkva2048_leaderboard';
            const BEST_KEY = 'krlkva2048_best';
            
            // Состояние игры
            let board = [];
            let score = 0;
            let best = 0;
            let history = [];
            let gameOver = false;
            
            // DOM элементы
            const boardElement = document.getElementById('board');
            const scoreElement = document.getElementById('score');
            const bestElement = document.getElementById('best');
            const multiplierElement = document.getElementById('multiplier');
            const mobileControls = document.getElementById('mobileControls');
            
            // Модальные окна
            const gameOverModal = document.getElementById('gameOverModal');
            const leaderboardModal = document.getElementById('leaderboardModal');
            const playerNameInput = document.getElementById('playerName');
            const saveScoreBtn = document.getElementById('saveScoreBtn');
            const savedMessage = document.getElementById('savedMessage');
            const restartFromModalBtn = document.getElementById('restartFromModalBtn');
            const leaderboardBody = document.getElementById('leaderboardBody');
            
            // Кнопки
            const newGameBtn = document.getElementById('newGameBtn');
            const undoBtn = document.getElementById('undoBtn');
            const leaderboardBtn = document.getElementById('leaderboardBtn');
            const closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
            
            // Множители для красоты
            const multipliers = ['x0.25', 'x0.5', 'x1', 'x2', 'x4'];
            let multiplierIndex = 2; // x1 по умолчанию
            
            // Инициализация
            function init() {
                loadGame();
                loadBest();
                
                if (!board.length || board.flat().every(cell => cell === 0)) {
                    resetBoard();
                }
                
                renderBoard();
                updateScore();
                updateMultiplier();
                checkGameOver();
                setupEventListeners();
            }
            
            function resetBoard() {
                board = Array(SIZE).fill().map(() => Array(SIZE).fill(0));
                addRandomTile();
                addRandomTile();
                if (Math.random() < 0.5) addRandomTile();
            }
            
            function addRandomTile() {
                const empty = [];
                for (let i = 0; i < SIZE; i++) {
                    for (let j = 0; j < SIZE; j++) {
                        if (board[i][j] === 0) empty.push([i, j]);
                    }
                }
                if (empty.length === 0) return false;
                
                const [row, col] = empty[Math.floor(Math.random() * empty.length)];
                board[row][col] = Math.random() < 0.9 ? 2 : 4;
                return true;
            }
            
            function addNewTiles() {
                const count = Math.random() < 0.5 ? 1 : 2;
                for (let i = 0; i < count; i++) {
                    if (!addRandomTile()) break;
                }
            }
            
            // Движение влево
            function moveLeft() {
                let moved = false;
                let scoreGain = 0;
                
                for (let i = 0; i < SIZE; i++) {
                    let row = board[i].filter(cell => cell !== 0);
                    
                    for (let j = 0; j < row.length - 1; j++) {
                        if (row[j] === row[j + 1]) {
                            row[j] *= 2;
                            scoreGain += row[j];
                            row.splice(j + 1, 1);
                            moved = true;
                        }
                    }
                    
                    while (row.length < SIZE) row.push(0);
                    
                    if (JSON.stringify(board[i]) !== JSON.stringify(row)) {
                        moved = true;
                    }
                    
                    board[i] = row;
                }
                
                if (moved) {
                    score += scoreGain;
                    updateScore();
                    addNewTiles();
                    saveGame();
                }
                
                return moved;
            }
            
            function moveRight() {
                for (let i = 0; i < SIZE; i++) {
                    board[i] = board[i].reverse();
                }
                const moved = moveLeft();
                for (let i = 0; i < SIZE; i++) {
                    board[i] = board[i].reverse();
                }
                if (moved) renderBoard();
                return moved;
            }
            
            function moveUp() {
                transpose();
                const moved = moveLeft();
                transpose();
                if (moved) renderBoard();
                return moved;
            }
            
            function moveDown() {
                transpose();
                for (let i = 0; i < SIZE; i++) {
                    board[i] = board[i].reverse();
                }
                const moved = moveLeft();
                for (let i = 0; i < SIZE; i++) {
                    board[i] = board[i].reverse();
                }
                transpose();
                if (moved) renderBoard();
                return moved;
            }
            
            function transpose() {
                for (let i = 0; i < SIZE; i++) {
                    for (let j = i + 1; j < SIZE; j++) {
                        [board[i][j], board[j][i]] = [board[j][i], board[i][j]];
                    }
                }
            }
            
            function saveToHistory() {
                history.push({
                    board: JSON.parse(JSON.stringify(board)),
                    score: score
                });
                if (history.length > 10) history.shift();
            }
            
            function undo() {
                if (history.length === 0 || gameOver) return;
                const prev = history.pop();
                board = prev.board;
                score = prev.score;
                renderBoard();
                updateScore();
                saveGame();
                checkGameOver();
            }
            
            function checkGameOver() {
                // Проверка пустых клеток
                for (let i = 0; i < SIZE; i++) {
                    for (let j = 0; j < SIZE; j++) {
                        if (board[i][j] === 0) {
                            gameOver = false;
                            return false;
                        }
                    }
                }
                
                // Проверка горизонтальных объединений
                for (let i = 0; i < SIZE; i++) {
                    for (let j = 0; j < SIZE - 1; j++) {
                        if (board[i][j] === board[i][j + 1]) {
                            gameOver = false;
                            return false;
                        }
                    }
                }
                
                // Проверка вертикальных объединений
                for (let i = 0; i < SIZE - 1; i++) {
                    for (let j = 0; j < SIZE; j++) {
                        if (board[i][j] === board[i + 1][j]) {
                            gameOver = false;
                            return false;
                        }
                    }
                }
                
                gameOver = true;
                showGameOverModal();
                return true;
            }
            
            function showGameOverModal() {
                gameOverModal.classList.remove('hidden');
                playerNameInput.classList.remove('hidden');
                saveScoreBtn.classList.remove('hidden');
                savedMessage.classList.add('hidden');
                restartFromModalBtn.classList.remove('hidden');
                mobileControls.style.display = 'none';
            }
            
            function saveRecord() {
                const name = playerNameInput.value.trim() || 'Аноним';
                const record = {
                    name: name,
                    score: score,
                    date: new Date().toLocaleDateString('ru-RU')
                };
                
                let leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
                leaderboard.push(record);
                leaderboard.sort((a, b) => b.score - a.score);
                leaderboard = leaderboard.slice(0, 10);
                
                localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));
                
                playerNameInput.classList.add('hidden');
                saveScoreBtn.classList.add('hidden');
                savedMessage.classList.remove('hidden');
                
                updateBest();
            }
            
            function updateBest() {
                if (score > best) {
                    best = score;
                    bestElement.textContent = best;
                    localStorage.setItem(BEST_KEY, best);
                }
            }
            
            function loadBest() {
                const savedBest = localStorage.getItem(BEST_KEY);
                if (savedBest) {
                    best = parseInt(savedBest, 10);
                    bestElement.textContent = best;
                }
            }
            
            function loadLeaderboard() {
                const leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
                leaderboardBody.innerHTML = '';
                
                if (leaderboard.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Пока нет рекордов</td></tr>';
                } else {
                    leaderboard.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.name}</td>
                            <td>${record.score}</td>
                            <td>${record.date}</td>
                        `;
                        leaderboardBody.appendChild(row);
                    });
                }
            }
            
            function saveGame() {
                const gameState = { board, score, history };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
            }
            
            function loadGame() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const gameState = JSON.parse(saved);
                        board = gameState.board || [];
                        score = gameState.score || 0;
                        history = gameState.history || [];
                    } catch (e) {
                        console.error('Ошибка загрузки', e);
                    }
                }
            }
            
            function newGame() {
                board = Array(SIZE).fill().map(() => Array(SIZE).fill(0));
                score = 0;
                history = [];
                gameOver = false;
                
                addRandomTile();
                addRandomTile();
                if (Math.random() < 0.5) addRandomTile();
                
                renderBoard();
                updateScore();
                saveGame();
                gameOverModal.classList.add('hidden');
                
                if (window.innerWidth <= 520) {
                    mobileControls.style.display = 'grid';
                }
            }
            
            function renderBoard() {
                boardElement.innerHTML = '';
                
                for (let i = 0; i < SIZE; i++) {
                    for (let j = 0; j < SIZE; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        const value = board[i][j];
                        
                        if (value !== 0) {
                            cell.textContent = value;
                            cell.classList.add(`tile-${value}`);
                        }
                        
                        boardElement.appendChild(cell);
                    }
                }
            }
            
            function updateScore() {
                scoreElement.textContent = score;
                updateBest();
            }
            
            function updateMultiplier() {
                multiplierIndex = (multiplierIndex + 1) % multipliers.length;
                multiplierElement.textContent = multipliers[multiplierIndex];
            }
            
            function setupEventListeners() {
                // Клавиатура
                document.addEventListener('keydown', (e) => {
                    if (gameOver || !gameOverModal.classList.contains('hidden') || !leaderboardModal.classList.contains('hidden')) return;
                    
                    const arrows = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
                    if (arrows.includes(e.key)) {
                        e.preventDefault();
                    }
                    
                    saveToHistory();
                    
                    switch(e.key) {
                        case 'ArrowLeft': moveLeft(); break;
                        case 'ArrowRight': moveRight(); break;
                        case 'ArrowUp': moveUp(); break;
                        case 'ArrowDown': moveDown(); break;
                        default: return;
                    }
                    
                    renderBoard();
                    checkGameOver();
                });
                
                // Мобильные кнопки
                document.querySelectorAll('.mobile-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (gameOver || !gameOverModal.classList.contains('hidden') || !leaderboardModal.classList.contains('hidden')) return;
                        
                        const direction = e.currentTarget.dataset.direction;
                        
                        saveToHistory();
                        
                        switch(direction) {
                            case 'left': moveLeft(); break;
                            case 'right': moveRight(); break;
                            case 'up': moveUp(); break;
                            case 'down': moveDown(); break;
                        }
                        
                        renderBoard();
                        checkGameOver();
                    });
                });
                
                newGameBtn.addEventListener('click', newGame);
                undoBtn.addEventListener('click', undo);
                
                leaderboardBtn.addEventListener('click', () => {
                    loadLeaderboard();
                    leaderboardModal.classList.remove('hidden');
                    mobileControls.style.display = 'none';
                });
                
                closeLeaderboardBtn.addEventListener('click', () => {
                    leaderboardModal.classList.add('hidden');
                    if (window.innerWidth <= 520 && !gameOver) {
                        mobileControls.style.display = 'grid';
                    }
                });
                
                saveScoreBtn.addEventListener('click', saveRecord);
                
                restartFromModalBtn.addEventListener('click', () => {
                    newGame();
                });
                
                // Закрытие модальных окон по клику на оверлей
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            overlay.classList.add('hidden');
                            if (window.innerWidth <= 520 && !gameOver) {
                                mobileControls.style.display = 'grid';
                            }
                        }
                    });
                });
                
                window.addEventListener('resize', () => {
                    if (window.innerWidth <= 520 && !gameOver && gameOverModal.classList.contains('hidden') && leaderboardModal.classList.contains('hidden')) {
                        mobileControls.style.display = 'grid';
                    } else if (window.innerWidth > 520) {
                        mobileControls.style.display = 'none';
                    }
                });
            }
            
            // Запуск
            init();
        })();
    </script>
</body>
</html>
